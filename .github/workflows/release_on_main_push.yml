name: Build and Release
run-name: Build and Release
on: 
    push:
      branches:
        - main
      
jobs:
    Build:
      if: ${{ !contains(github.event.head_commit.message, '[skip build]') }}
      name: Build and Release
      runs-on: ubuntu-latest
      steps:
        - name: "Checkout repository"
          uses: actions/checkout@v4
        
        # - name: Install uv
        #   uses: astral-sh/setup-uv@v4
        #   with:
        #     enable-cache: true
        #     cache-dependency-glob: "requirements**.txt"
  
        - name: "Set up Python"
          uses: actions/setup-python@v5
          with:
            python-version-file: "pyproject.toml"

        # - name: Install requirements
        #   run: uv pip install -r requirements.txt
        #   env:
        #     UV_SYSTEM_PYTHON: 1

        - name: Build
          run: python package.py build --yes

        - name: "Create Github Release"
          run: |
            gh release create "$PACKAGE_BUILD_VERSION" \
              ./dist/*.tar.gz \
              ./dist/*.whl \
              --repo="$GITHUB_REPOSITORY" \
              --title="$PACKAGE_BUILD_VERSION" \
              --generate-notes

        - name: Push docs to gh-pages branch.
          run: |
            if git show-ref --verify --quiet refs/heads/gh-pages; then
              echo "gh-pages branch exists."
            else
              echo "gh-pages branch does not exist. Creating gh-pages branch."
              git checkout --orphan gh-pages
              git reset --hard
            fi
            git add docs/*
            git push origin HEAD:gh-pages
  
        - name: Minimize uv cache
          run: uv cache prune --ci
       
        